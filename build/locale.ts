/* eslint-disable no-console */

/**
 * @file dayjs/localeにあるすべてのロケールを集約したファイルを生成します。
 */

import fs from "fs/promises";
import path from "path";
import locales from "dayjs/locale.json";

const note =
  "// THIS FILE WAS GENERATED AUTOMATICALLY BY `build/locale.ts`\n" +
  "// DO NOT EDIT THIS FILE BY HAND\n";
const outDir = path.posix.normalize("src");
const outFile = path.posix.join(outDir, "locale.ts");
const localeDeclarationPath = path.posix.normalize(
  "node_modules/dayjs/locale/index.d.ts",
);
const localeDeclaration = `/// <reference path="${path.posix.relative(
  outDir,
  localeDeclarationPath,
)}" />\n`;
const localeKeys: string[] = locales.map((locale) => locale.key);

function disableEslintRules(rules: string[]): string {
  return `/* eslint-disable ${rules.join(", ")} */\n`;
}

function generateLocaleIndex(files: string[]): string {
  const lines: string[] = files.map(
    (file: string) =>
      `export { default as ${file.replace(/-/g, "_")} } from "${path.posix.join(
        "dayjs/locale",
        file,
      )}";`,
  );

  return `${
    note +
    disableEslintRules(["@typescript-eslint/triple-slash-reference"]) +
    localeDeclaration +
    lines.join("\n")
  }\n`;
}

async function main() {
  await fs.writeFile(outFile, generateLocaleIndex(localeKeys));
  console.log("Locale build succeeded");
}

main().catch((err) => {
  console.error(err);
  throw err;
});
