// @ts-check
/* eslint-disable no-console, @typescript-eslint/no-var-requires */

/**
 * @file dayjs/localeにあるすべてのロケールを集約したファイルを生成する
 */

const fs = require("fs/promises");
const path = require("path");
const locales = require("dayjs/locale.json");

const note =
  "// THIS FILE WAS GENERATED AUTOMATICALLY BY `build/locale.js`\n" +
  "// DO NOT EDIT THIS FILE BY HAND\n";
const outDir = path.posix.normalize("src");
const outFile = path.posix.join(outDir, "locale.ts");
const localeDeclarationPath = path.posix.normalize("node_modules/dayjs/locale/index.d.ts");
const localeDeclaration = `/// <reference path="${path.posix.relative(
  outDir,
  localeDeclarationPath
)}" />\n`;
const localeKeys = locales.map((locale) => locale.key);

/**
 * @param {string[]} rules
 * @returns {string}
 */
const disableEslintRules = (rules) =>
  `/* eslint-disable ${rules.join(", ")} */\n`;

/**
 * @param {string[]} files
 * @returns {string}
 */
const generateLocaleIndex = (files) => {
  const lines = files.map(
    (file) =>
      `export { default as ${file.replace(
        /-/g,
        "_"
      )} } from "${path.posix.join('dayjs/locale', file)}";`
  );

  return `${
    note +
    disableEslintRules(["@typescript-eslint/triple-slash-reference"]) +
    localeDeclaration +
    lines.join("\n")
  }\n`;
};

fs.writeFile(outFile, generateLocaleIndex(localeKeys)).then(
  () => console.log("Locale build succeeded"),
  (error) => {
    throw error;
  },
);
